name: train_vision
description: Train AutoML Vision model for crop analysis

inputs:
- {name: project_id, type: String, description: 'GCP project ID'}
- {name: region, type: String, description: 'GCP region'}
- {name: dataset, type: String, description: 'URI of the processed vision dataset'}
- {name: min_accuracy, type: Float, description: 'Minimum required accuracy'}

outputs:
- {name: model_info, type: Dict, description: 'Model information including resource name and metrics'}

implementation:
  container:
    image: python:3.9
    command:
    - sh
    - -c
    - |
      python3 -m pip install --quiet google-cloud-aiplatform pandas numpy pillow
      python3 -c '

      import sys
      import argparse
      from google.cloud import aiplatform

      import os
      
      # Get parameters from environment variables
      project_id = os.environ['PROJECT_ID']
      region = os.environ['REGION']
      dataset = os.environ['DATASET']
      min_accuracy = float(os.environ['MIN_ACCURACY'])

      # Initialize Vertex AI
      aiplatform.init(project=project_id, location=region)

      # Create dataset
      ai_dataset = aiplatform.ImageDataset.create(
          display_name="crop_vision_dataset",
          gcs_source=dataset
      )

      # Train model
      job = aiplatform.AutoMLImageTrainingJob(
          display_name="crop_vision_model",
          prediction_type="classification"
      )

      # Run the training job
      ai_model = job.run(
          dataset=ai_dataset,
          model_display_name="crop_vision_model",
          training_fraction_split=0.8,
          validation_fraction_split=0.1,
          test_fraction_split=0.1
      )

      # Get model evaluation
      eval_metrics = ai_model.list_model_evaluations()[0]

      # Check if model meets accuracy threshold
      if eval_metrics.metrics['auRoc'] < min_accuracy:
          raise ValueError(f"Model accuracy {eval_metrics.metrics['auRoc']} below threshold {min_accuracy}")

      # Print output as JSON for KFP
      import json
      model_info = {
          'model': ai_model.resource_name,
          'accuracy': float(eval_metrics.metrics['auRoc'])
      }
      print(json.dumps(model_info))
      '
    env:
      PROJECT_ID: {inputValue: project_id}
      REGION: {inputValue: region}
      DATASET: {inputValue: dataset}
      MIN_ACCURACY: {inputValue: min_accuracy}
